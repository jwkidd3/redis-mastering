<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistence & High Availability</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/reveal.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/theme/white.min.css">
    <style>
        :root {
            --r-main-font: 'Arial', sans-serif;
            --r-heading-font: 'Arial', sans-serif;
            --r-main-font-size: 32px;
            --r-heading1-size: 2.2em;
            --r-heading2-size: 1.8em;
            --r-heading3-size: 1.4em;
        }
        
        .reveal .slides section {
            text-align: left;
            font-size: var(--r-main-font-size);
        }
        
        .reveal h1, .reveal h2, .reveal h3 {
            text-align: center;
            text-transform: none;
            margin-bottom: 30px;
        }
        
        .title-block {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 40px;
            border-radius: 10px;
            text-align: center;
            color: #2c3e50;
            margin: 20px 0;
        }
        
        .session-header {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            color: #2c3e50;
            margin: 20px 0;
        }
        
        .lab-callout {
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            border-left: 8px solid #e17055;
            padding: 25px;
            margin: 20px 0;
            border-radius: 8px;
            text-align: center;
        }
        
        .lab-callout h2 {
            color: #d63031;
            margin: 0 0 15px 0;
            font-size: 1.5em;
        }
        
        .lab-callout .duration {
            font-weight: bold;
            color: #2d3436;
            font-size: 1.1em;
        }
        
        .code-block {
            background-color: #2d3436;
            color: #dfe6e9;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            margin: 20px 0;
            overflow-x: auto;
        }
        
        .highlight-box {
            background: linear-gradient(135deg, #e1f5fe 0%, #b3e5fc 100%);
            border-left: 5px solid #039be5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .warning-box {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 5px solid #ff9800;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .feature-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: transform 0.3s;
        }
        
        .metrics-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .metrics-table th, .metrics-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .metrics-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        ul {
            font-size: 0.9em;
            line-height: 1.6;
            margin-left: 20px;
        }
    </style>
</head>
<body>
    <div class="reveal">
        <div class="slides">
            <!-- Title Slide -->
            <section>
                <div class="title-block">
                    <h1>Persistence & High Availability</h1>
                    <p style="font-size: 1.2em; margin-top: 20px;">
                        <strong>Content 8</strong> • Redis Mastering Course<br>
                        Data Durability and System Resilience
                    </p>
                </div>
            </section>

            <!-- Overview -->
            <section>
                <div class="session-header">
                    <h2>Session Overview</h2>
                </div>
                <h3>What We'll Cover</h3>
                <ul>
                    <li>Redis persistence mechanisms (RDB & AOF)</li>
                    <li>Backup and recovery strategies</li>
                    <li>High availability with Redis Sentinel</li>
                    <li>Replication patterns and topologies</li>
                    <li>Data consistency guarantees</li>
                    <li>Disaster recovery planning</li>
                </ul>
            </section>

            <!-- Part 1: Persistence Fundamentals -->
            <section>
                <div class="session-header">
                    <h2>Part 1: Persistence Fundamentals</h2>
                </div>
            </section>

            <!-- RDB Persistence -->
            <section>
                <h2>RDB (Redis Database) Snapshots</h2>
                <div class="highlight-box">
                    <strong>Point-in-time snapshots of your dataset</strong>
                </div>
                <h3>Key Characteristics:</h3>
                <ul>
                    <li>Compact single-file representation</li>
                    <li>Perfect for backups and disaster recovery</li>
                    <li>Faster Redis restarts with large datasets</li>
                    <li>Minimal performance impact during creation</li>
                </ul>
            </section>

            <!-- RDB Configuration -->
            <section>
                <h2>RDB Configuration</h2>
                <div class="code-block">
# Automatic save points
save 900 1      # After 900 sec if at least 1 key changed
save 300 10     # After 300 sec if at least 10 keys changed
save 60 10000   # After 60 sec if at least 10000 keys changed

# RDB file settings
dbfilename dump.rdb
dir /var/lib/redis/

# Compression and checksum
rdbcompression yes
rdbchecksum yes</div>
            </section>

            <!-- Manual RDB Operations -->
            <section>
                <h2>Manual RDB Operations</h2>
                <h3>Triggering Snapshots:</h3>
                <div class="code-block">
# Synchronous save (blocks Redis)
SAVE

# Asynchronous save (background)
BGSAVE

# Check last save time
LASTSAVE

# Monitor background save progress
INFO persistence</div>
                <div class="warning-box">
                    <strong>⚠️ Warning:</strong> SAVE blocks all clients during snapshot creation
                </div>
            </section>

            <!-- AOF Persistence -->
            <section>
                <h2>AOF (Append Only File)</h2>
                <div class="highlight-box">
                    <strong>Log every write operation received by the server</strong>
                </div>
                <h3>Key Characteristics:</h3>
                <ul>
                    <li>More durable than RDB</li>
                    <li>Human-readable and editable log format</li>
                    <li>Automatic corruption recovery</li>
                    <li>Multiple fsync policies for durability vs performance</li>
                </ul>
            </section>

            <!-- AOF Configuration -->
            <section>
                <h2>AOF Configuration</h2>
                <div class="code-block">
# Enable AOF
appendonly yes
appendfilename "appendonly.aof"

# Fsync policies
# appendfsync always    # Slowest, safest
appendfsync everysec    # Good compromise
# appendfsync no        # Fastest, least safe

# AOF rewrite settings
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# AOF loading truncation
aof-load-truncated yes</div>
            </section>

            <!-- RDB vs AOF Comparison -->
            <section>
                <h2>RDB vs AOF Comparison</h2>
                <table class="metrics-table">
                    <tr>
                        <th>Aspect</th>
                        <th>RDB</th>
                        <th>AOF</th>
                    </tr>
                    <tr>
                        <td>Data Loss Risk</td>
                        <td>Minutes of data</td>
                        <td>1 second max</td>
                    </tr>
                    <tr>
                        <td>File Size</td>
                        <td>Compact</td>
                        <td>Larger</td>
                    </tr>
                    <tr>
                        <td>Recovery Speed</td>
                        <td>Fast</td>
                        <td>Slower</td>
                    </tr>
                    <tr>
                        <td>Performance Impact</td>
                        <td>Minimal</td>
                        <td>Depends on fsync</td>
                    </tr>
                </table>
            </section>

            <!-- Hybrid Persistence -->
            <section>
                <h2>Hybrid Persistence Strategy</h2>
                <div class="highlight-box">
                    <strong>Best Practice: Use both RDB and AOF together</strong>
                </div>
                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>RDB for:</h3>
                        <ul>
                            <li>Faster restarts</li>
                            <li>Backup archives</li>
                            <li>Disaster recovery</li>
                        </ul>
                    </div>
                    <div class="feature-card">
                        <h3>AOF for:</h3>
                        <ul>
                            <li>Minimal data loss</li>
                            <li>Audit trail</li>
                            <li>Point-in-time recovery</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Lab 13 Callout -->
            <section>
                <div class="lab-callout">
                    <h2>🔬 Lab 13: Production Configuration</h2>
                    <p class="duration">Duration: 45 minutes</p>
                    <p>Configure persistence, memory management, and security for production Redis deployment</p>
                </div>
            </section>

            <!-- Part 2: Replication -->
            <section>
                <div class="session-header">
                    <h2>Part 2: Replication & High Availability</h2>
                </div>
            </section>

            <!-- Replication Basics -->
            <section>
                <h2>Redis Replication</h2>
                <div class="highlight-box">
                    <strong>Asynchronous master-replica replication</strong>
                </div>
                <h3>Key Features:</h3>
                <ul>
                    <li>Non-blocking on master and replicas</li>
                    <li>Multiple replicas per master</li>
                    <li>Cascading replication support</li>
                    <li>Partial resynchronization on reconnect</li>
                </ul>
            </section>

            <!-- Replication Configuration -->
            <section>
                <h2>Setting Up Replication</h2>
                <h3>On Replica Server:</h3>
                <div class="code-block">
# Configure as replica
replicaof masterhost 6379

# Authentication if needed
masterauth masterpassword

# Replica priority for Sentinel
replica-priority 100

# Read-only replicas (default)
replica-read-only yes</div>
                <h3>Dynamic Configuration:</h3>
                <div class="code-block">
# Make instance a replica
REPLICAOF masterhost 6379

# Promote to master
REPLICAOF NO ONE</div>
            </section>

            <!-- Replication Monitoring -->
            <section>
                <h2>Monitoring Replication</h2>
                <div class="code-block">
# Check replication status
INFO replication

# Master output shows:
# role:master
# connected_slaves:2
# slave0:ip=10.0.0.2,port=6379,state=online,offset=1234
# slave1:ip=10.0.0.3,port=6379,state=online,offset=1234

# Replica output shows:
# role:slave
# master_host:10.0.0.1
# master_port:6379
# master_link_status:up
# master_sync_in_progress:0</div>
            </section>

            <!-- Redis Sentinel -->
            <section>
                <h2>Redis Sentinel</h2>
                <div class="highlight-box">
                    <strong>Automated failover and monitoring system</strong>
                </div>
                <h3>Sentinel Capabilities:</h3>
                <ul>
                    <li><strong>Monitoring:</strong> Check if masters and replicas are working</li>
                    <li><strong>Notification:</strong> Alert administrators about events</li>
                    <li><strong>Automatic failover:</strong> Promote replica to master</li>
                    <li><strong>Configuration provider:</strong> Service discovery for clients</li>
                </ul>
            </section>

            <!-- Sentinel Configuration -->
            <section>
                <h2>Sentinel Configuration</h2>
                <div class="code-block">
# sentinel.conf
port 26379

# Monitor master
sentinel monitor mymaster 127.0.0.1 6379 2
sentinel auth-pass mymaster yourpassword

# Failover settings
sentinel down-after-milliseconds mymaster 5000
sentinel parallel-syncs mymaster 1
sentinel failover-timeout mymaster 60000

# Notification script
sentinel notification-script mymaster /path/to/notify.sh</div>
                <div class="warning-box">
                    <strong>Note:</strong> Quorum (2) = minimum Sentinels to agree for failover
                </div>
            </section>

            <!-- Sentinel Deployment -->
            <section>
                <h2>Sentinel Deployment Architecture</h2>
                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>Minimum Setup:</h3>
                        <ul>
                            <li>3 Sentinel instances</li>
                            <li>1 Master</li>
                            <li>2 Replicas</li>
                            <li>Quorum of 2</li>
                        </ul>
                    </div>
                    <div class="feature-card">
                        <h3>Production Setup:</h3>
                        <ul>
                            <li>5 Sentinel instances</li>
                            <li>1 Master</li>
                            <li>3+ Replicas</li>
                            <li>Quorum of 3</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Sentinel Commands -->
            <section>
                <h2>Sentinel Operations</h2>
                <div class="code-block">
# Connect to Sentinel
redis-cli -p 26379

# Check master info
SENTINEL masters

# Check replicas of master
SENTINEL replicas mymaster

# Get master address
SENTINEL get-master-addr-by-name mymaster

# Force failover
SENTINEL failover mymaster

# Reset master (after manual intervention)
SENTINEL reset mymaster</div>
            </section>

            <!-- Part 3: Backup Strategies -->
            <section>
                <div class="session-header">
                    <h2>Part 3: Backup & Recovery</h2>
                </div>
            </section>

            <!-- Backup Strategies -->
            <section>
                <h2>Backup Strategies</h2>
                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>RDB Backups:</h3>
                        <ul>
                            <li>Schedule BGSAVE</li>
                            <li>Copy dump.rdb file</li>
                            <li>Store offsite</li>
                            <li>Test restoration</li>
                        </ul>
                    </div>
                    <div class="feature-card">
                        <h3>AOF Backups:</h3>
                        <ul>
                            <li>Stop writes briefly</li>
                            <li>Copy AOF file</li>
                            <li>Or use BGREWRITEAOF</li>
                            <li>Compress and archive</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Automated Backup Script -->
            <section>
                <h2>Automated Backup Example</h2>
                <div class="code-block">
#!/bin/bash
# Redis backup script

BACKUP_DIR="/backup/redis"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
REDIS_CLI="redis-cli"

# Trigger background save
$REDIS_CLI BGSAVE

# Wait for completion
while [ $($REDIS_CLI LASTSAVE) -eq $lastsave ]; do
  sleep 1
done

# Copy files
cp /var/lib/redis/dump.rdb $BACKUP_DIR/dump_$TIMESTAMP.rdb
cp /var/lib/redis/appendonly.aof $BACKUP_DIR/aof_$TIMESTAMP.aof

# Compress
gzip $BACKUP_DIR/*_$TIMESTAMP.*

# Upload to S3 (example)
aws s3 cp $BACKUP_DIR/ s3://backups/redis/ --recursive</div>
            </section>

            <!-- Recovery Procedures -->
            <section>
                <h2>Recovery Procedures</h2>
                <h3>RDB Recovery:</h3>
                <ol>
                    <li>Stop Redis server</li>
                    <li>Replace dump.rdb with backup</li>
                    <li>Start Redis server</li>
                    <li>Verify data integrity</li>
                </ol>
                <h3>AOF Recovery:</h3>
                <ol>
                    <li>Stop Redis server</li>
                    <li>Fix corrupted AOF: <code>redis-check-aof --fix</code></li>
                    <li>Replace appendonly.aof</li>
                    <li>Start Redis server</li>
                </ol>
            </section>

            <!-- Part 4: Data Consistency -->
            <section>
                <div class="session-header">
                    <h2>Part 4: Data Consistency</h2>
                </div>
            </section>

            <!-- Consistency Levels -->
            <section>
                <h2>Consistency Guarantees</h2>
                <table class="metrics-table">
                    <tr>
                        <th>Configuration</th>
                        <th>Consistency Level</th>
                        <th>Performance</th>
                    </tr>
                    <tr>
                        <td>No persistence</td>
                        <td>None</td>
                        <td>Highest</td>
                    </tr>
                    <tr>
                        <td>RDB only</td>
                        <td>Eventual</td>
                        <td>High</td>
                    </tr>
                    <tr>
                        <td>AOF everysec</td>
                        <td>Near real-time</td>
                        <td>Good</td>
                    </tr>
                    <tr>
                        <td>AOF always</td>
                        <td>Strong</td>
                        <td>Lower</td>
                    </tr>
                </table>
            </section>

            <!-- WAIT Command -->
            <section>
                <h2>Synchronous Replication with WAIT</h2>
                <div class="code-block">
# Wait for write to reach N replicas
SET key value
WAIT 2 1000  # Wait for 2 replicas, timeout 1000ms

# Returns number of replicas that acknowledged
# Can be less than requested if timeout</div>
                <div class="highlight-box">
                    <strong>Use Case:</strong> Critical writes requiring confirmation
                </div>
            </section>

            <!-- Part 5: Disaster Recovery -->
            <section>
                <div class="session-header">
                    <h2>Part 5: Disaster Recovery Planning</h2>
                </div>
            </section>

            <!-- DR Checklist -->
            <section>
                <h2>Disaster Recovery Checklist</h2>
                <h3>✓ Preparation:</h3>
                <ul>
                    <li>Document Redis topology and configuration</li>
                    <li>Automate backup procedures</li>
                    <li>Test restore procedures regularly</li>
                    <li>Monitor replication lag</li>
                </ul>
                <h3>✓ During Incident:</h3>
                <ul>
                    <li>Identify failure scope</li>
                    <li>Activate Sentinel failover if configured</li>
                    <li>Restore from latest backup if needed</li>
                    <li>Verify data consistency</li>
                </ul>
            </section>

            <!-- RTO and RPO -->
            <section>
                <h2>RTO and RPO Targets</h2>
                <div class="feature-grid">
                    <div class="feature-card">
                        <h3>Recovery Time Objective (RTO):</h3>
                        <ul>
                            <li>Sentinel failover: &lt; 30 seconds</li>
                            <li>Manual failover: 5-10 minutes</li>
                            <li>Full restore: 15-60 minutes</li>
                        </ul>
                    </div>
                    <div class="feature-card">
                        <h3>Recovery Point Objective (RPO):</h3>
                        <ul>
                            <li>AOF always: 0 data loss</li>
                            <li>AOF everysec: 1 second</li>
                            <li>RDB only: Minutes to hours</li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- Best Practices -->
            <section>
                <h2>High Availability Best Practices</h2>
                <ul>
                    <li><strong>Use both RDB and AOF</strong> for maximum protection</li>
                    <li><strong>Deploy odd number of Sentinels</strong> (3, 5, 7)</li>
                    <li><strong>Distribute Sentinels</strong> across failure domains</li>
                    <li><strong>Monitor replication lag</strong> continuously</li>
                    <li><strong>Test failover procedures</strong> regularly</li>
                    <li><strong>Automate backup verification</strong></li>
                    <li><strong>Document recovery procedures</strong></li>
                    <li><strong>Set up alerting</strong> for persistence failures</li>
                </ul>
            </section>

            <!-- Performance Considerations -->
            <section>
                <h2>Performance Impact</h2>
                <div class="warning-box">
                    <h3>⚠️ Performance Considerations:</h3>
                </div>
                <ul>
                    <li><strong>BGSAVE:</strong> Fork overhead with large datasets</li>
                    <li><strong>AOF rewrite:</strong> I/O intensive operation</li>
                    <li><strong>Replication:</strong> Network bandwidth usage</li>
                    <li><strong>fsync always:</strong> Significant write latency</li>
                </ul>
                <div class="highlight-box">
                    <strong>Tip:</strong> Schedule intensive operations during low-traffic periods
                </div>
            </section>

            <!-- Lab 14 Callout -->
            <section>
                <div class="lab-callout">
                    <h2>🔬 Lab 14: Monitoring & Health Checks</h2>
                    <p class="duration">Duration: 45 minutes</p>
                    <p>Implement comprehensive monitoring, alerting, and health check systems for production Redis</p>
                </div>
            </section>

            <!-- Summary -->
            <section>
                <div class="session-header">
                    <h2>Summary</h2>
                </div>
                <h3>Key Takeaways:</h3>
                <ul>
                    <li>RDB provides efficient point-in-time snapshots</li>
                    <li>AOF offers better durability with write logging</li>
                    <li>Combine both for optimal protection</li>
                    <li>Sentinel automates failover for high availability</li>
                    <li>Regular backups and testing ensure recoverability</li>
                    <li>Balance durability requirements with performance needs</li>
                </ul>
            </section>

            <!-- Q&A -->
            <section>
                <div class="session-header">
                    <h2>Questions & Discussion</h2>
                </div>
                <h3>Topics for Discussion:</h3>
                <ul>
                    <li>Persistence strategy for your workload</li>
                    <li>Acceptable data loss windows</li>
                    <li>High availability requirements</li>
                    <li>Backup automation approaches</li>
                    <li>Disaster recovery testing</li>
                </ul>
            </section>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/4.3.1/reveal.min.js"></script>
    <script>
        Reveal.initialize({
            hash: true,
            controls: true,
            progress: true,
            center: false,
            transition: 'slide',
            backgroundTransition: 'fade'
        });
    </script>
</body>
</html>